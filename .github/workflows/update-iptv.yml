name: 更新IPTV源

# 触发条件：手动触发 + 每天自动运行
on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 8 * * *'  # 每天UTC时间8点（北京时间16点）自动运行

jobs:
  build:
    runs-on: ubuntu-latest  # 使用Ubuntu环境

    steps:
      - name: 拉取代码仓库
        uses: actions/checkout@v4

      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # 兼容脚本的Python版本

      - name: 安装依赖
        working-directory: ./mobileunicast  # 依赖文件在mobileunicast目录
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 运行脚本生成IPTV文件
        run: |
          # 从项目根目录运行脚本，确保输出到根目录/output
          python mobileunicast/unicast.py --top 20

      - name: 提交更新到仓库
        run: |
          # 配置Git身份
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查根目录output文件夹的文件变化（关键修改）
          git add output/iptv.m3u output/iptv.txt
          git commit -m "自动更新IPTV源: $(date +'%Y-%m-%d %H:%M:%S')" || echo "无更新内容"
          git push
